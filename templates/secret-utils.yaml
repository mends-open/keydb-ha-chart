apiVersion: v1
kind: Secret
metadata:
  name: {{ include "keydb.fullname" . }}-utils
  labels:
    {{- include "keydb.labels" . | nindent 4 }}
type: Opaque
stringData:
  server.sh: |
    #!/bin/bash
    set -euxo pipefail

    host="$(hostname)"
    replicas=()
    for node in {0..{{ sub (.Values.nodes | int) 1 }}}; do
      if [ "${host}" != "{{ include "keydb.fullname" . }}-${node}" ]; then
        replicas+=("replicaof {{ include "keydb.fullname" . }}-${node}.{{ include "keydb.fullname" . }}-headless {{ .Values.service.port }}")
      fi
    done
    
    # Write the config text to a file
    cat <<EOF > /etc/keydb/redis.conf
    {{ .Values.config | nindent 4 }}
    EOF

    # Append the replica settings to the config file
    for replica in "${replicas[@]}"; do
      echo "${replica}" >> /etc/keydb/redis.conf
    done

    # Start keydb-server with the final configuration file
    exec keydb-server /etc/keydb/redis.conf
