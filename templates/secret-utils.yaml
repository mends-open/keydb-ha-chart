apiVersion: v1
kind: Secret
metadata:
  name: {{ include "keydb.fullname" . }}-utils
  labels:
    {{- include "keydb.labels" . | nindent 4 }}
type: Opaque
stringData:
  server.sh: |
    #!/bin/sh
    set -euxo pipefail

    host="$(hostname)"
    replicas=()
    node=0
    while [ $node -lt {{ .Values.nodes | int }} ]; do
      if [ "${host}" != "{{ include "keydb.fullname" . }}-${node}" ]; then
        replicas="${replicas} replicaof {{ include "keydb.fullname" . }}-${node}.{{ include "keydb.fullname" . }}-headless {{ .Values.service.port }}"
      fi
      node=$((node + 1))
    done

    # Write the config text to a file
    cat <<EOF > /etc/keydb/redis.conf
    {{ .Values.config | indent 4 }}
    EOF

    # Append the replica settings to the config file
    for replica in $replicas; do
      echo "$replica" >> /etc/keydb/redis.conf
    done

    # Start keydb-server with the final configuration file
    exec keydb-server /etc/keydb/redis.conf
