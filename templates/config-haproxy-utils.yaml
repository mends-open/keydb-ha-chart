apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-haproxy-utils
  labels:
    {{- include "keydb.labels" . | nindent 4 }}
data:
  haproxy-config.sh: |
    #!/bin/sh
    set -euxo pipefail

    host="$(hostname)"
    replicas=""
    node=0
    while [ $node -lt {{ .Values.replicas | int }} ]; do
      if [ $node -eq 0 ]; then
        replicas="${replicas}    server {{ .Release.Name }}-${node}.{{ .Release.Name }}-headless:{{ .Values.service.port }} check\n"
      else
        replicas="${replicas}    server {{ .Release.Name }}-${node}.{{ .Release.Name }}-headless:{{ .Values.service.port }} check backup\n"
      fi
      node=$((node + 1))
    done

    # Write the config text to a file
    cat <<EOF > /usr/local/etc/haproxy/haproxy.cfg
    {{ .Values.haproxy.configTemplate | nindent 4 }}
    ${replicas}
    EOF

    exec haproxy -f /usr/local/etc/haproxy/haproxy.cfg
